@page "/product/{ProductId:int}"
@rendermode InteractiveServer
@layout MainLayout
@inject ShopContext Db
@inject NavigationManager Navigation
@inject IStoreService Ss
@inject SessionState Session;
@using ECommerceShop.Configurations
@using ECommerceShop.DLL
@using ECommerceShop.Entities

@using Microsoft.EntityFrameworkCore
@using View.Components.Layout
@inject LocalStorageService LocalStorage
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm py-3">
    <div class="container-fluid d-flex justify-content-between align-items-center">

        <!-- Logo -->
        <a class="navbar-brand fw-bold fs-3 text-dark" href="/" style="margin-right: 30px;">
            BulkBase
        </a>

        <!-- Navigation Buttons -->
        <div class="d-flex align-items-center gap-2">
            <a class="nav-link custom-nav-link" href="/">Home</a>
            <a class="nav-link custom-nav-link" href="/products">Products</a>
        </div>

        <!-- Sign Out + Cart -->
        <div class="d-flex align-items-center gap-3">
            <button class="btn logout-btn fw-semibold" @onclick="Logout">Sign Out</button>
            <a class="nav-link position-relative" href="/cart">
                <img src="images/warenkorb.jpg" alt="Cart" style="height: 30px;" />
            </a>
        </div>
    </div>
</nav>
<style>
    .custom-nav-link {
        color: black;

        font-weight: 500;

        font-size: 1.2rem;
        padding: 7px 14px;
        border-radius: 6px;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .custom-nav-link:hover {
        background-color: #f0f0f0;
        color: #000;
        text-decoration: none;
    }

    .logout-btn {
        background-color: transparent;
        border: 2px solid #1f1f1f;
        color: #1f1f1f;
        padding: 6px 16px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .logout-btn:hover {
        background-color: #1f1f1f;
        color: white;
    }
</style>
@code {
    private async Task Logout()
    {
        await LocalStorage.ClearUserData();
        Navigation.NavigateTo("/login", forceLoad: true);
    }
}

@*push*@
<!-- CONTENT -->
@code {
    private void AddToCart()
    {
        if (product != null)
        {
            Ss.AddToCart("h.muster", product.ProductId, quantity);
        }
    }

    
[Parameter]
public int ProductId { get; set; }

private Product? product;
private int quantity = 1;
private bool _initialized = false;

protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender && !_initialized)
    {
        _initialized = true;

        var username = await LocalStorage.GetUsername();
        if (string.IsNullOrEmpty(username))
        {
            Navigation.NavigateTo("/login", forceLoad: true);
        }
    }
}
protected override async Task OnInitializedAsync()
{
    
product = await Db.Products.FirstOrDefaultAsync(p => p.ProductId == ProductId);
}

private void IncreaseQuantity()
{
quantity++;
}

private void DecreaseQuantity()
{
if (quantity > 1)
quantity--;
}
}

@if (product == null)
{
<div class="container text-center mt-5">
    <h2>Product not found</h2>
</div>
}
else
{
<div class="container mt-5">
    <div class="row">
        <!-- Bildervorschau -->
        <div class="col-md-2 d-none d-md-block">
            <img src="@product.Image" class="img-thumbnail mb-3" />
            <img src="@product.Image" class="img-thumbnail mb-3" />
            <img src="@product.Image" class="img-thumbnail mb-3" />
        </div>

        <!-- Hauptbild -->
        <div class="col-md-5 text-center mb-4 mb-md-0">
            <img src="@product.Image" class="img-fluid" style="max-height: 350px;" />
        </div>

        <!-- Produktdetails -->
        <div class="col-md-5">
            <h2>@product.Name</h2>
            <div class="text-warning mb-2">
                ★★★★☆ <span class="text-muted">(50 Reviews)</span>
            </div>
            <p class="fs-4 fw-bold">@product.Price.ToString("0.00")€</p>
            <p>@product.Description</p>

            <p class="text-success fw-bold">✔ in stock</p>
            <p>Lagernd: @product.InStock+</p>

            <!-- Menge -->
            <div class="input-group mb-3" style="width: 150px;">
                <button class="btn btn-outline-secondary" @onclick="DecreaseQuantity">-</button>
                <input type="text" class="form-control text-center" value="@quantity" readonly />
                <button class="btn btn-outline-secondary" @onclick="IncreaseQuantity">+</button>
            </div>

            <!-- Add to Cart -->
            <button class="btn text-white w-100 mb-3" style="background-color:#C30017;" @onclick="AddToCart">Add to Cart</button>



            <!-- Lieferung -->
            <div class="border p-3">
                <p><strong>🚚 Free Delivery</strong></p>
                <p>Enter your postal code for Delivery Availability</p>
                <hr />
                <p><strong>🔁 Return Delivery</strong></p>
                <p>Free 30 days delivery returns.</p>
            </div>
        </div>
    </div>
</div>
}
